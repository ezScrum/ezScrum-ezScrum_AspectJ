*** Settings ***
Documentation     test ezScrumn page
Suite Setup       Test Product Backlog Suite Setup
Suite Teardown    Test Product Backlog Suite Teardown
Force Tags        ProductBacklog
Resource          keywords/common_resource.txt
Resource          keywords/ezScrum_Login.txt
Resource          keywords/Project/ezScrum_Project.txt
Resource          keywords/ProductBacklog/ezScrum_ProductBacklog_Story.txt
Resource          keywords/ProductBacklog/ezScrum_ProductBacklog_Tag.txt
Resource          keywords/ProductBacklog/ezScrum_ProductBacklog_Filter.txt
Resource          keywords/ProductBacklog/ezScrum_ProductBacklog_Search.txt
Resource          keywords/ProductBacklog/ezScrum_ProductBacklog_SetupTeardown.txt
Resource          keywords/SprintPlan/ezScrum_SprintPlan_Sprint.txt
Resource          keywords/ReleasePlan/ezScrum_ReleasePlan_Management.txt
Resource          ServerConfig.txt
Resource          Global Define.txt
Library           keywords/lib/Selenium2Improved.py

*** Variables ***
${tsTag}          testTagName    # 測試正常字元
${tsTagX}         Tag_~!@#$%^&*()_+=-`\|][{}'/":;    # 測試特殊字元
@{tsStoryA}       ID    Name    Value    Estimate    Importance    Notes    Tags
...               How To Demo
@{tsStoryB}       ID    Name    Value    Estimate    Importance    Notes    Tags
...               How To Demo

*** Test Cases ***
Test ProductBacklog - Create Story Identify Invalid Value
    [Documentation]    Add Story(長度限制),Add Story (測試限制數字欄位),Add Story (測試特殊字元)
    [Setup]    Test Product Backlog Create Story Identify Invalid Value Setup
    Click Element    xpath=//button[text()="Add Story"]
    Wait Until Page Contains    Add New Story
    Verify Invalid Value Textarea    Name    zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
    Verify Invalid Value    Value    a
    Verify Invalid Value    Value    &
    Verify Invalid Value    Value    \\
    Verify Invalid Value    Estimate    a
    Verify Invalid Value    Estimate    &
    Verify Invalid Value    Estimate    \\
    Verify Invalid Value    Importance    a
    Verify Invalid Value    Importance    &
    Verify Invalid Value    Importance    \\
    ${xpathCreateStoryCancel}=    Find Current Window Element    Add New Story    Cancel
    Element Should Be Visible    xpath=${xpathCreateStoryCancel}
    Click Element    xpath=${xpathCreateStoryCancel}
    [Teardown]    Test Product Backlog Create Story Identify Invalid Value Teardown

Test ProductBacklog - Edit Story Identify Invalid Value
    [Documentation]    Edit Story(長度限制),Edit Story (測試限制數字欄位),Edit Story (測試特殊字元)
    [Setup]    Test Edit Story Identify Invalid Value Setup
    Wait Until Page Contains Element    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="new Edit Story With Invalid Value")]
    Mouse Down    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="new Edit Story With Invalid Value")]
    Mouse Up    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="new Edit Story With Invalid Value")]
    Click Element    xpath=//button[text()="Edit Story"]
    Wait Until Page Contains    Edit Story
    Verify Invalid Value Textarea    Name    zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
    Verify Invalid Value    Value    a
    Verify Invalid Value    Value    &
    Verify Invalid Value    Value    \\
    Verify Invalid Value    Estimate    a
    Verify Invalid Value    Estimate    &
    Verify Invalid Value    Estimate    \\
    Verify Invalid Value    Importance    a
    Verify Invalid Value    Importance    &
    Verify Invalid Value    Importance    \\
    ${storyID}=    Get Story ID
    ${xpathEditStoryCancel}=    Find Current Window Element    Edit Story #${storyID}    Cancel
    Element Enable And Submit    ${xpathEditStoryCancel}
    [Teardown]    Test Edit Story Identify Invalid Value Teardown

Test ProductBacklog - Create Story
    [Documentation]    Add Story(正常資料)。點選按鈕Add Story，對各個欄位輸入資料，Tag欄位勾選Tag後送出。
    [Setup]    Test Create Story Setup
    Create Tag With Arguments    testTagName
    Create Story With Arguments    newStory    5    3    1    testTagName    Note: newStory
    ...    HowToDemo: newStory
    ${storyID}=    Get Story ID
    Verify Story Information With Arguments    ${storyID}    newStory    5    3    1    Note: newStory
    ...    HowToDemo: newStory
    [Teardown]    Test Create Story Teardown

Test ProductBacklog - Create Story With Invalid Value
    [Setup]    Test Create Story With Invalid Value Setup
    Create Tag With Arguments    testTagName
    Create Story With Arguments    Tag_~!@#$%^&*()_+=-`\|][{}'/":;    0    0    0    testTagName    Tag_~!@#$%^&*()_+=-`\|][{}'/":;
    ...    Tag_~!@#$%^&*()_+=-`\|][{}'/":;
    ${storyID}=    Get Story ID
    Verify Story Information With Arguments    ${storyID}    Tag_~!@#$%^&*()_+=-`\|][{}'/":;    0    0    0    Tag_~!@#$%^&*()_+=-`\|][{}'/":;
    ...    Tag_~!@#$%^&*()_+=-`\|][{}'/":;
    [Teardown]    Test Create Story With Invalid Value Teardown    ${storyID}

Test ProductBacklog - Edit Story
    [Documentation]    Add Story(正常資料)。點選Story，點選按鈕Edit Story，修改各個欄位資料，Tag欄位勾選/取消勾選Tag後送出。
    [Setup]    Test Edit Story Setup
    Edit Story With Arguments    oriStory    testTagName
    ${storyID}=    Get Story ID
    Verify Story Information With Arguments    ${storyID}    EditStoryName    3    5    8    EditStoryNotes
    ...    EditStoryHowToDemo
    [Teardown]    Test Edit Story Teardown    ${storyID}

Test ProductBacklog - Story History
    [Documentation]    點選一Story，點選按鈕Show History，確認History列表，有顯示的資訊皆為正確的後關閉視窗。
    [Setup]    Test Story History Setup
    Set Test Variable    ${storyName}    newStory
    # Set Selenium Speed 1
    ${storyID}=    Get Text    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="${storyName}")]/../..//div[@class="x-grid3-cell-inner x-grid3-col-1"]
    Mouse Down    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="${storyName}")]
    Mouse Up    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="${storyName}")]
    Click Element    xpath=//button[text()="Show History"]
    ${storyHistoryTitleInformation}    Get Text    xpath=//span[text()="Issue History List"]/../../../../..//span[@class="x-panel-header-text"]/font
    Should Be Equal As Strings    ${storyHistoryTitleInformation}    ＜Story＞ #${storyID} ${storyName}
    Comment    Click Element    xpath=//button[text()="Close"]
    ${xpathIssueHistoryListClose}=    Find Current Window Element    Issue History List    Close
    Element Enable And Submit    ${xpathIssueHistoryListClose}
    # Set Selenium Speed 0
    # Test Product Backlog Filter
    # [Documentation] 建立多Story後點選按鈕Filter, 測試 Backlogged, Detailed, Done, Default。
    # [Setup] Test Product Backlog Filter Setup
    # 測試各Filter
    # Test Product Backlog Filter Backlogged
    # Test Product Backlog Filter Detailed
    # Test Product Backlog Filter Done
    # Test Product Backlog Filter Default
    # [Teardown] Test Product Backlog Filter Teardown
    # Test Product Backlog AttachFile
    # [Documentation] 點選一Story，點選按鈕Attach File，請選擇任一檔案上傳。\n點選一Story，展開該Story，點選Delete。\n*# 夾帶檔案目前有問題, 透過robot的Choose File或是Call Selenium Api無法成功夾帶檔案, 可以成功送出, 但不會出現迴紋針符號, 再重新進到ProductBacklog會讀取很久, 且發現該Story消失。*
    # Test Product Backlog AttachFile Invalid Character
    # [Documentation] 點選一Story，點選按鈕Attach File，各別選擇事先建立好的檔案(系統檔檔名為#,%,&,+的空檔)上傳。\n*夾帶檔案目前有問題, 透過robot的Choose File或是Call Selenium Api無法成功夾帶檔案, 可以成功送出, 但不會出現迴紋針符號, 再重新進到ProductBacklog會讀取很久, 且發現該Story消失。*
    # Test Product Backlog Search
    # [Documentation] 於Search欄位，點選下拉式選單的項目，在於field填入要搜尋的keyword，各別作搜尋的測試(Release, Sprint用None為 keyword即可)。*#BUG, 新增完一筆story後, 直接點選"Please Select...", 表格內不顯示該story*
    # [Setup] Test Product Backlog Search Setup
    # Set Selenium Speed 1
    # Story Name 測試
    # Set Product Backlog Search Condition Story Name newStoryFirst
    # Set Selenium Speed 0
    # Element Should Be Visible xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFirst")]
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStorySecond")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryThird")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFourth")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFifth")] 0
    # Notes 測試
    # Set Product Backlog Search Condition Notes newStorySecond
    # Set Selenium Speed 0
    # Element Should Be Visible xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStorySecond")]
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFirst")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryThird")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFourth")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFifth")] 0
    # How To Demo 測試
    # Set Product Backlog Search Condition How To Demo newStoryThird
    # Set Selenium Speed 0
    # Element Should Be Visible xpath=//div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryThird")]
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFirst")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStorySecond")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFourth")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFifth")] 0
    # Release 測試
    # Set Product Backlog Search Condition Release none
    # Set Selenium Speed 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFirst")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStorySecond")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryThird")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFourth")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFifth")] 0
    # Sprint ID 測試
    # Set Product Backlog Search Condition Sprint ID none
    # Set Selenium Speed 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFirst")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStorySecond")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryThird")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFourth")] 0
    # Xpath Should Match X Times //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="newStoryFifth")] 0
    # [Teardown] Test Product Backlog Search Teardown
    # Set Selenium Speed 0
    [Teardown]    Test Story History Teardown

Test ProductBacklog - Remove Story Tag
    [Documentation]    Remove Tag
    [Tags]    tag
    [Setup]    Test Remove Story Tag Setup
    Delete Tag With Arguments    testTagName
    ${storyID}=    Get Story ID
    Click Element    xpath=//div[@id="productBacklogGridPanel"]/div[2]/div/div/div/div/div/div/div/div/div/table/tbody/tr
    Verify Story Information With Arguments    ${storyID}    newStory    5    3    1    Note: newStory
    ...    HowToDemo: newStory
    [Teardown]    Test Remove Story Tag Teardown

Test ProductBacklog - Create Tag
    [Documentation]    測試兩種Tag: 正常字串 & 特殊字元
    ...
    ...
    ...    test Tag 'C'RD
    [Tags]    tag
    [Setup]    Test Create Tag Setup
    # open Tag Manage window
    Click Element    xpath=//button[text()="Manage Tag"]
    # add tagName: \ Normal
    Click Element    xpath=//button[text()="Add Tag"]
    Input Text    xpath=//input[@name="newTagName"]    ${tsTag}
    ${xpathAddTag} =    Find Current Window Element    Add Tag    Submit
    Wait Until Page Contains Element    xpath=//table[@class='x-btn \ \ x-btn-noicon ']
    Element Enable And Submit    ${xpathAddTag}
    Wait Until Page Contains    ${tsTag}
    # add tagName: \ Special
    Click Element    xpath=//button[text()="Add Tag"]
    Input Text    xpath=//input[@name="newTagName"]    ${tsTagX}
    ${xpathAddTag} =    Find Current Window Element    Add Tag    Submit
    Wait Until Page Contains Element    xpath=//table[@class='x-btn \ \ x-btn-noicon ']
    Element Enable And Submit    ${xpathAddTag}
    Wait Until Page Contains    ${tsTagX}
    # check if 正常字串 tag added
    Element Text Should Be    xpath=(//div[@class="x-grid3-cell-inner x-grid3-col-Name"])[1]    ${tsTag}
    # check if 特殊字元 tag added
    Element Text Should Be    xpath=(//div[@class="x-grid3-cell-inner x-grid3-col-Name"])[2]    ${tsTagX}
    [Teardown]    Test Create Tag Teardown

Test ProductBacklog - Duplicate Tag
    [Documentation]    測試輸入已存在的Tag Name(特殊字元)
    ...
    ...    test Tag C'R'D
    [Tags]    tag
    [Setup]    Test Duplicate Tag Setup
    Create Tag With Arguments    ${tsTagX}
    ${tag}=    Set Variable    ${tsTagX}
    # add already existed Tag
    Click Element    xpath=//button[text()="Manage Tag"]
    Click Element    xpath=//button[text()="Add Tag"]
    Input Text    xpath=//input[@name="newTagName"]    ${tag}
    ${xpathAddTag}=    Find Current Window Element    Add Tag    Submit
    Wait Until Page Contains Element    xpath=//table[@class='x-btn \ \ x-btn-noicon ']
    Element Enable And Submit    ${xpathAddTag}
    # assert
    ${alertMessage}=    Get Alert Message
    ${correctAlertMessage}=    Set Variable    Tag Name : ${tag} already exist
    Should Be Equal As Strings    ${alertMessage}    ${correctAlertMessage}
    # close Add Tag window
    ${xpathAddTagClose}=    Find Current Window Element    Add Tag    Close
    Click Element    xpath=${xpathAddTagClose}
    # check again
    ${tagCount}=    Count Tag Amount With Arguments    ${tag}
    ${text}=    Get Text    xpath=(//div[@class="x-grid3-cell-inner x-grid3-col-Name"])[${tagCount}]
    Should Be Equal    ${tag}    ${text}
    # close Tag Manage window
    ${xpathTagManageClose}=    Find Current Window Element    Tag Manage    Close
    Click Element    xpath=${xpathTagManageClose}
    [Teardown]    Test Duplicate Tag Teardown

Test ProductBacklog - Delete Tag
    [Documentation]    test Tag CR'D'
    [Tags]    tag
    [Setup]    Test Delete Tag Setup    3
    ${testTagCount}    Set Variable    3
    # get existed Tag count
    ${tagCount} =    Get Matching Xpath Count    //div[@class="x-grid3-cell-inner x-grid3-col-Name"]
    Set Selenium Speed    ${SELENIUM_SPEED_SLOW}    # stable issue
    # delete & check    testTagName_3
    : FOR    ${index}    IN RANGE    0    ${tagCount}
    \    Mouse Down    xpath=(//div[@class="x-grid3-cell-inner x-grid3-col-Name"])[${tagCount} - ${index}]
    \    Mouse Up    xpath=(//div[@class="x-grid3-cell-inner x-grid3-col-Name"])[${tagCount} - ${index}]
    \    Click Element    xpath=//button[text()="Remove Tag"]
    \    Click Element    xpath=//tbody[ @class="x-btn-small x-btn-icon-small-left" and .//button[text()="Yes"] ]
    \    ${expectedCount}=    Evaluate    ${tagCount} - ${index} - 1
    \    ${count}=    Get Matching Xpath Count    //div[@class="x-grid3-cell-inner x-grid3-col-Name"]
    \    ${realCount}=    Convert To Integer    ${count}
    \    Should Be Equal    ${expectedCount}    ${realCount}    # integer compare
    Set Selenium Speed    ${SELENIUM_SPEED}    # restore origional speed
    # check if Tag empty
    ${tagCount} =    Get Matching Xpath Count    //div[@class="x-grid3-cell-inner x-grid3-col-Name"]
    Should Be Equal    0    ${tagCount}    # string compare
    [Teardown]    Test Delete Tag Teardown

Test ProductBacklog - Filter - Backlogged
    [Documentation]    確認Backlogged Filter正常運作
    [Setup]    Test Product Backlog Filter Setup
    Test Product Backlog Filter Backlogged
    [Teardown]    Test Product Backlog Filter Teardown

Test ProductBacklog - Filter - Detailed
    [Documentation]    確認Detailed Filter正常運作
    [Setup]    Test Product Backlog Filter Setup
    Test Product Backlog Filter Detailed
    [Teardown]    Test Product Backlog Filter Teardown

Test ProductBacklog - Filter - Default
    [Documentation]    確認Detailed Filter正常運作
    [Setup]    Test Product Backlog Filter Setup
    Test Product Backlog Filter Default
    [Teardown]    Test Product Backlog Filter Teardown

Test ProductBacklog - Attach File
    [Setup]    Test Attach File Setup
    Click Element    xpath=//tr/td[@class="x-grid3-col x-grid3-cell x-grid3-td-3 "]/div[text()="oriStory"]
    Click Element    xpath=//button[text()="Attach File"]
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    TaskBoard    Story01AttachFile.txt
    Choose File    //input[@name="file"]    ${attachFilePath}
    ${xpathAttachFile}=    Find Current Window Element    Attach File    Submit
    Click Element    xpath=${xpathAttachFile}
    Wait Until Page Contains    Attach File Success.
    Wait Until Element Is Visible    //tbody/tr/td[@class="x-grid3-col x-grid3-cell x-grid3-td-3 "]/div[@class="x-grid3-cell-inner x-grid3-col-3"]/img
    [Teardown]    Test Attach File Teardown

Test ProductBacklog - Invailid Change Line
    [Setup]    Test ProductBacklog With Change Line Setup
    Wait Until Page Contains    oriStory
    # 比對 +號 content
    ${storyID}=    Get Story ID
    Mouse Down    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-1" and text()="${storyID}"]/../../td[1]/.//div[@class="x-grid3-row-expander"]
    Mouse Down    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-1" and text()="${storyID}"]/../../td[1]/.//div[@class="x-grid3-row-expander"]
    ${testNameText}=    Get Text    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-1" and (text()="${storyID}")]/../../../tr[2]/.//b[text()="Name:"]/..
    Should Be Equal    ${testNameText}    Name:\noriStory
    ${testNotesText}=    Get Text    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-1" and (text()="${storyID}")]/../../../tr[2]/.//b[text()="Notes:"]/..
    Should Be Equal    ${testNotesText}    Notes:\nNote: newStory\nChangeLine
    ${testHowToDemoText}=    Get Text    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-1" and (text()="${storyID}")]/../../../tr[2]/.//b[text()="How To Demo:"]/..
    Should Be Equal    ${testHowToDemoText}    How To Demo:\nHowToDemo: newStory\nChangeLine
    [Teardown]    Test Edit Story Teardown    ${storyID}

Test ProductBacklog - 123
    [Setup]    Test Product Backlog Create Story Identify Invalid Value Setup
    Build a Story    story1    8    90
    Build a Story    story2    5    85
    Check Content    story1    1    8    90
    Check Content    story2    2    5    85
    #delete the story1
    Select A Story And Delete    story1
    Comment    ${logTest}=    Get Value
    Comment    Log    ${logTest}
    Edit Story Importance    story2    95
    Clean Database and Exit ezScrum
    Close Browser
